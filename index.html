<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Demo tracking location A8</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
    #map {
    height: 100%;
    }
    /* Optional: Makes the sample page fill the window. */
    html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    }

    #top-box-map {
    position: fixed;
    display: block;
    width: 100%;
    height: 10%;
    z-index: 2;
    cursor: pointer;
    margin: auto;
    padding-top: 125px;
    }

    #text-box-map{
    position: absolute;
    top: 50%;
    left: 50%;
    font-size: 45px;
    color: white;
    transform: translate(-50%,-50%);
    -ms-transform: translate(-50%,-50%);
    background-color: rgba(236, 166, 34, 0.5);
    padding: 20px;
    width: 50%;
    height: 30px;
    margin: 10px;
    }

    #snackbar {
        visibility: hidden;
        min-width: 300px; /* width of bar */
        margin-left: -125px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 3px;
        padding: 16px;
        position: fixed;
        z-index: 1;
        left: 50%;
        bottom: 30px;
    }

    /* Show the snackbar when clicking on a button (class added with JavaScript) */
    #snackbar.show {
        visibility: visible; /* Show the snackbar */
        -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
        opacity: 0.85;
    }
    @-webkit-keyframes fadein {
        from {bottom: 0; opacity: 0;} 
        to {bottom: 30px; opacity: 1;}
    }
    @keyframes fadein {
        from {bottom: 0; opacity: 0;}
        to {bottom: 30px; opacity: 1;}
    }
    @-webkit-keyframes fadeout {
        from {bottom: 30px; opacity: 1;} 
        to {bottom: 0; opacity: 0;}
    }
    @keyframes fadeout {
        from {bottom: 30px; opacity: 1;}
        to {bottom: 0; opacity: 0;}
    }

    </style>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div id="top-box-map">
        <div id="text-box-map" onclick="topBoxMap();" >hello it's me</div>
    </div>
    <div id="snackbar"></div>
    <div id="map"></div>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCw_Uh8npqpbpwW0JS1G7X1sSSpZ1AVGAI&callback=initMap">
    </script>
    <script>

        var markers = {};
        var map;
        var socket = io();
        var markerGeo;

        function snackBar(snackBarText, s) {
            var snackbar = document.getElementById("snackbar")
            // Add the "show" class to DIV
            snackbar.className = "show";
            snackbar.innerHTML = snackBarText;
            // After 3 seconds, remove the show class from DIV
            setTimeout(function() {
                snackbar.className = snackbar.className.replace("show", ""); 
            }, s);
        };

        function initMap() {
        
            URL = window.location.href;
            socket = io.connect(URL);

            socket.on("connect", function() {
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 18,
                    center: {lat: 13.651011, lng: 100.493944}
                });
                snackBar("You have connected to server.", 3500);


                //busA1 marker
            var busA1Marker;
            // socket.on('trackingBusA1Broadcast', busA1 => {
            //     console.log('A1 --> ' +busA1);
            //     let busGeo = {
            //         lat: busA1.lat,
            //         lng: busA1.lng
            //     }
            //     if (busA1Marker == null) {
            //         busA1Marker = new google.maps.Marker({
            //             position: busGeo,
            //             map: map,
            //             icon: {
            //                 url: '/static/test.png',
            //                 size: new google.maps.Size(150, 150),
            //                 scaledSize: new google.maps.Size(50, 50),
            //                 origin: new google.maps.Point(0, 0),
            //                 anchor: new google.maps.Point(25, 25),
            //                 optimized: false
            //             }
            //         });
            //     } else {
            //         busA1Marker.setPosition(busGeo);
            //     }
            // });

            // socket.on('trackingBusA1Broadcast', function(busA1) {
            //     console.log(busA1);
            // });

            var busA2Marker;
            socket.on('trackingBusA2Broadcast', busA2 => {
                console.log('A2 --> ' + busA2);
                let busGeo = {
                    lat: busA2.lat,
                    lng: busA2.lng
                }
                if (busA2Marker == null) {
                    busA2Marker = new google.maps.Marker({
                        position: busGeo,
                        map: map,
                        icon: {
                            url: '/static/truck-R2.png',
                            size: new google.maps.Size(150, 150),
                            scaledSize: new google.maps.Size(50, 50),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(25, 25),
                            optimized: false
                        }
                    });
                } else {
                    busA2Marker.setPosition(busGeo);
                }
            });



            });

            socket.on("disconnect", function() {
                snackBar("You have been disconnected from server.", 10000);
            });

            socket.on("locationUpdated", function(locationState){
                for (var k in locationState) {
                    newMarker(k, locationState[k]);
                }
            });

            // //busA1 marker
            // var busA1Marker;
            // socket.on('trackingBusA1Broadcast', busA1 => {
            //     console.log('A1 --> ' +busA1);
            //     let busGeo = {
            //         lat: busA1.lat,
            //         lng: busA1.lng
            //     }
            //     if (busA1Marker == null) {
            //         busA1Marker = new google.maps.Marker({
            //             position: busGeo,
            //             map: map,
            //             icon: {
            //                 url: '/static/test.png',
            //                 size: new google.maps.Size(150, 150),
            //                 scaledSize: new google.maps.Size(50, 50),
            //                 origin: new google.maps.Point(0, 0),
            //                 anchor: new google.maps.Point(25, 25),
            //                 optimized: false
            //             }
            //         });
            //     } else {
            //         busA1Marker.setPosition(busGeo);
            //     }
            // });

            // var busA2Marker;
            // socket.on('trackingBusA2Broadcast', busA2 => {
            //     console.log('A2 --> ' + busA2);
            //     let busGeo = {
            //         lat: busA2.lat,
            //         lng: busA2.lng
            //     }
            //     if (busA2Marker == null) {
            //         busA2Marker = new google.maps.Marker({
            //             position: busGeo,
            //             map: map,
            //             icon: {
            //                 url: '/static/truck-R2.png',
            //                 size: new google.maps.Size(150, 150),
            //                 scaledSize: new google.maps.Size(50, 50),
            //                 origin: new google.maps.Point(0, 0),
            //                 anchor: new google.maps.Point(25, 25),
            //                 optimized: false
            //             }
            //         });
            //     } else {
            //         busA2Marker.setPosition(busGeo);
            //     }
            // });


            // var busA1;
            // socket.on('trackingBusA1Broadcast', busA1 => {
            //     var posGeoBus = {
            //     lat: busA1.lat,
            //     lng: busA1.lng
            // }
            // console.log(busA1);
            //     if (busA1 == null) {
            //     markerGeo = new google.maps.Marker({
            //     position: posGeoBus,
            //     map: map,
            //         icon: {
            //             url: '/static/test.png',
            //             size: new google.maps.Size(150, 150),
            //             scaledSize: new google.maps.Size(50, 50),
            //             origin: new google.maps.Point(0, 0),
            //             anchor: new google.maps.Point(25, 25),
            //             optimized: false
            //         }
            //     });
            // } else {
            //     markerGeo.setPosition(posGeoBus);
            // }
            // })

//** repeat code **
            socket.on("locationUpdatedR2", function(locationStateR2){
                for (var kR2 in locationStateR2) {
                    newMarkerR2(kR2, locationStateR2[kR2]);
                }
            });
        }; ///////////// finish init()

            // busA1 marker
            var busA1Marker;
            let i = 0;
            socket.on("trackingBusA1Broadcast", function(data){
                console.log(data);
                let posGeoBus = {
                    lat: data.lat,
                    lng: data.lng
                }
                if (busA1Marker == null) {
                        busA1Marker = new google.maps.Marker({
                        position: posGeoBus,
                        map: map,
                        icon: {
                            url: '/static/test.png',
                            size: new google.maps.Size(150, 150),
                            scaledSize: new google.maps.Size(50, 50),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(25, 25),
                            optimized: false
                        }
                    });
                } else {
                    busA1Marker.setPosition(posGeoBus);
                }


            });

        function newMarkerBusA1(k, location) {
        if (busA1Marker[k] == null) {
            busA1Marker[k] = new google.maps.Marker({
                position : location,
                map: map,
                icon: {
                    url: '/static/test.png',
                    size: new google.maps.Size(100, 100),
                    scaledSize: new google.maps.Size(50, 50),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(25, 25),
                    optimized: false
                } 
            });
        } else {
            busA1Marker[k].setPosition(location);
        }    
    };



        function newMarker(k, location) {
            if (markers[k] == null) {
                markers[k] = new google.maps.Marker({
                    position : location,
                    map: map,
                    icon: {
                        url: '/static/truck.png',
                        size: new google.maps.Size(100, 100),
                        scaledSize: new google.maps.Size(50, 50),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(25, 25),
                        optimized: false
                    } 
                });
            } else {
                markers[k].setPosition(location);
            }    
        };

        function newMarkerR2(k, location) {
            if (markers[k] == null) {
                markers[k] = new google.maps.Marker({
                    position : location,
                    map: map,
                    icon: {
                        url: '/static/truck-R2.png',
                        size: new google.maps.Size(100, 100),
                        scaledSize: new google.maps.Size(50, 50),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(25, 25),
                        optimized: false
                    } 
                });
            } else {
                markers[k].setPosition(location);
            } 
        };

        function topBoxMap() {
            socket.on("locationUpdatedR2", function(locationStateR2){
                for (var kR2 in locationStateR2) {
                    document.getElementById("text-box-map").innerText = locationStateR2[kR2].lat + "+" + locationStateR2[kR2].lng
                }
            });
            
        };

        var options = {
            enableHighAccuracy: false,
            timeout: 1000,
            maximumAge: 0
        };
        
        function successGeo(pos) {
            var crd = pos.coords;
            var posGeo = {
                lat: crd.latitude,
                lng: crd.longitude
            }
            console.log('Your current position is:');
            console.log('Latitude : ' + crd.latitude);
            console.log('Longitude: ' + crd.longitude);
            console.log('More or less ' + crd.accuracy + ' meters.');
            if (markerGeo == null) {
                markerGeo = new google.maps.Marker({
                position: posGeo,
                map: map,
                    icon: {
                        url: '/static/locator.png',
                        size: new google.maps.Size(150, 150),
                        scaledSize: new google.maps.Size(50, 50),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(25, 25),
                        optimized: false
                    }
                });
            } else {
                markerGeo.setPosition(posGeo);
            }
        };

        
        //bug some devices

        // alert('Latitude : ' + crd.latitude + 'Longitude: ' + crd.longitude + 'More or less ' + crd.accuracy + ' meters.')

        // function markerGeo(k, posGeo) {
        //     if (markers[k] == null) {
        //         markers[k] = new google.maps.Marker({
        //             position : location,
        //             map: map,
        //             icon: {
        //                 url: '/static/truck-R2.png',
        //                 size: new google.maps.Size(100, 100),
        //                 scaledSize: new google.maps.Size(50, 50),
        //                 origin: new google.maps.Point(0, 0),
        //                 anchor: new google.maps.Point(25, 25),
        //                 optimized: false
        //             } 
        //         });
        //     } else {
        //         markers[k].setPosition(posGeo);
        //     } 
        // };
        
        // var markerGeo = new google.maps.Marker({
        //     position: posGeo,
        //     map: map,
        //         icon: {
        //             url: '/static/locator.png',
        //             size: new google.maps.Size(150, 150),
        //             scaledSize: new google.maps.Size(50, 50),
        //             origin: new google.maps.Point(0, 0),
        //             anchor: new google.maps.Point(25, 25),
        //             optimized: false
        //         }
        //     })

        // function newGeoMarker(posGeo) {
        //     if(markerGeo == null) {
        //         var markerGeo = new google.maps.Marker({
        //             position: posGeo,
        //             map: map,
        //             icon: {
        //                 url: '/static/locator.png',
        //                 size: new google.maps.Size(150, 150),
        //                 scaledSize: new google.maps.Size(50, 50),
        //                 origin: new google.maps.Point(0, 0),
        //                 anchor: new google.maps.Point(25, 25),
        //                 optimized: false
        //             }    
        //         })
        //     } else {
        //         markerGeo.setPosition(posGeo);
        //     }
        // };
        
        function error(err) {
            console.warn('ERROR(' + err.code + '): ' + err.message);
        };
        //function call
        navigator.geolocation.watchPosition(successGeo, error, options);

    </script>
  </body>
</html>